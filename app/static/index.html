<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRAT - Pay Request Approval Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
            line-height: 1.6;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
            background: #f1f5f9;
            overflow: hidden;
            gap: 16px;
            padding: 16px;
        }

        /* Left Panel: PO File Explorer */
        .po-explorer-panel {
            width: 350px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            min-width: 300px;
            max-width: 600px;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .po-explorer-panel .resize-handle {
            position: absolute;
            right: -2px;
            top: 0;
            bottom: 0;
            width: 6px;
            background: #e2e8f0;
            cursor: col-resize;
            transition: background 0.2s;
            z-index: 10;
        }

        .po-explorer-panel .resize-handle:hover {
            background: #94a3b8;
            width: 8px;
            right: -4px;
        }

        .po-explorer-panel .resize-handle:active {
            background: #64748b;
            width: 8px;
            right: -4px;
        }

        .panel-header {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            background: #f8fafc;
        }

        .panel-header h2 {
            font-size: 16px;
            font-weight: 600;
            color: #0f172a;
            margin-bottom: 8px;
        }

        .panel-header .subtitle {
            font-size: 12px;
            color: #64748b;
        }

        .folder-selector {
            margin-top: 16px;
            position: relative;
        }

        .folder-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 12px;
            margin-bottom: 8px;
            background-color: white;
            color: #0f172a;
            cursor: text;
            transition: all 0.2s ease;
        }

        .folder-input:focus {
            outline: none;
            border-color: #3b82f6;
            background-color: white;
            color: #0f172a;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .folder-input:hover {
            border-color: #cbd5e1;
        }

        .folder-selector .btn-small {
            margin-right: 8px;
            margin-bottom: 4px;
        }

        .folder-selector .btn-small:last-child {
            margin-right: 0;
        }

        .btn-small {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            background: #3b82f6;
            color: white;
            transition: background 0.2s;
        }

        .btn-small:hover {
            background: #2563eb;
        }

        .po-stats {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .stat-item {
            text-align: center;
            flex: 1;
        }

        .stat-skipped .stat-number {
            color: #f59e0b;
        }

        .stat-error .stat-number {
            color: #ef4444;
        }

        .stat-number {
            font-size: 18px;
            font-weight: 700;
            color: #0f172a;
        }

        .stat-label {
            font-size: 10px;
            color: #64748b;
            text-transform: uppercase;
        }

        .po-file-list {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .po-file-item {
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 4px;
            cursor: pointer;
            transition: background 0.2s ease;
            border-left: 3px solid transparent;
        }

        .po-file-item:hover {
            background: #f1f5f9;
        }

        .po-file-item.processed {
            border-left-color: #10b981;
            background: #f0fdf4;
        }

        .po-file-item.pending {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }

        .po-file-item.error {
            border-left-color: #ef4444;
            background: #fef2f2;
        }

        .po-file-name {
            font-size: 12px;
            font-weight: 500;
            color: #0f172a;
            margin-bottom: 2px;
        }

        .po-file-details {
            font-size: 10px;
            color: #64748b;
        }

        .po-file-status {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            margin-top: 4px;
            padding: 2px 6px;
            border-radius: 10px;
            background: #f1f5f9;
            color: #475569;
            display: inline-block;
        }

        .po-file-item.processed .po-file-status {
            background: #dcfce7;
            color: #166534;
        }

        .po-file-item.skipped .po-file-status {
            background: #fef3c7;
            color: #92400e;
        }

        .po-file-item.error .po-file-status {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Center Panel: Invoice Management */
        .invoice-panel {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            min-width: 400px;
            max-width: 800px;
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .invoice-panel .resize-handle {
            position: absolute;
            right: -2px;
            top: 0;
            bottom: 0;
            width: 6px;
            background: #e2e8f0;
            cursor: col-resize;
            transition: background 0.2s;
            z-index: 10;
        }

        .invoice-panel .resize-handle:hover {
            background: #94a3b8;
            width: 8px;
            right: -4px;
        }

        .invoice-panel .resize-handle:active {
            background: #64748b;
            width: 8px;
            right: -4px;
        }

        .invoice-header {
            margin-bottom: 16px;
            flex-shrink: 0;
        }

        .invoice-header h3 {
            margin: 0 0 8px 0;
            color: #1e293b;
            font-size: 18px;
            font-weight: 600;
        }

        .invoice-controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 16px;
            flex-shrink: 0;
        }

        .invoice-table {
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            overflow: hidden;
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .invoice-table-header {
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            padding: 12px;
            display: grid;
            grid-template-columns: 50px 120px 200px 100px 100px 100px 100px 100px;
            gap: 12px;
            font-weight: 600;
            font-size: 12px;
            color: #475569;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .invoice-table-body {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
            max-height: none;
        }

        .table-row {
            display: grid;
            grid-template-columns: 50px 120px 200px 100px 100px 100px 100px 100px;
            gap: 12px;
            padding: 12px;
            border-bottom: 1px solid #f1f5f9;
            align-items: center;
            cursor: pointer;
            transition: background 0.2s;
            min-height: 48px;
            box-sizing: border-box;
        }

        .table-row:hover {
            background: #f8fafc;
        }

        .table-row.selected {
            background: #dbeafe;
            border-left: 3px solid #3b82f6;
        }

        .checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-processing {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-approved {
            background: #dcfce7;
            color: #166534;
        }

        .status-rejected {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-review {
            background: #fef3c7;
            color: #92400e;
        }

        .recommendation {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            min-width: 24px;
        }

        .recommendation.approved {
            background: #dcfce7;
            color: #166534;
        }

        .recommendation.rejected {
            background: #fee2e2;
            color: #991b1b;
        }

        .recommendation.pending {
            background: #f1f5f9;
            color: #64748b;
        }

        .recommendation.review {
            background: #fef3c7;
            color: #92400e;
        }

        .btn-small {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            background: #3b82f6;
            color: white;
            transition: background 0.2s;
        }

        .btn-small:hover {
            background: #2563eb;
        }

        .btn-primary {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            background: #3b82f6;
            color: white;
            transition: background 0.2s;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .chat-panel {
            width: 400px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            min-width: 300px;
            max-width: 500px;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-panel .resize-handle {
            position: absolute;
            left: -2px;
            top: 0;
            bottom: 0;
            width: 6px;
            background: #e2e8f0;
            cursor: col-resize;
            transition: background 0.2s;
            z-index: 10;
        }

        .chat-panel .resize-handle:hover {
            background: #94a3b8;
            width: 8px;
            left: -4px;
        }

        .chat-panel .resize-handle:active {
            background: #64748b;
            width: 8px;
            left: -4px;
        }

        .chat-header {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            background: #f8fafc;
        }

        .chat-header h2 {
            font-size: 16px;
            font-weight: 600;
            color: #0f172a;
            margin-bottom: 8px;
        }

        .chat-status {
            font-size: 12px;
            color: #10b981;
            font-weight: 500;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .message {
            margin-bottom: 16px;
            display: flex;
            flex-direction: column;
        }

        .message.user {
            align-items: flex-end;
        }

        .message.assistant {
            align-items: flex-start;
        }

        .message-bubble {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.4;
        }

        .message.user .message-bubble {
            background: #3b82f6;
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.assistant .message-bubble {
            background: #f1f5f9;
            color: #0f172a;
            border-bottom-left-radius: 4px;
        }

        .message-time {
            font-size: 11px;
            color: #94a3b8;
            margin-top: 4px;
        }

        .quick-actions {
            padding: 16px;
            border-top: 1px solid #e2e8f0;
        }

        .quick-actions h4 {
            font-size: 12px;
            font-weight: 600;
            color: #475569;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .btn-action {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 12px;
            background: white;
            color: #475569;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s ease;
        }

        .btn-action:hover {
            background: #f8fafc;
            border-color: #cbd5e1;
        }

        .chat-input {
            padding: 16px;
            border-top: 1px solid #e2e8f0;
            background: white;
            position: relative;
            z-index: 10;
            /* Debug: Make sure it's visible */
            border: 2px solid #e2e8f0;
            margin: 8px;
            border-radius: 8px;
        }

        .chat-input-container {
            display: flex;
            gap: 8px;
            align-items: center;
            width: 100%;
            /* Debug: Ensure container is visible */
            min-height: 44px;
        }

        .chat-input input {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 20px;
            font-size: 14px;
            background: white;
            color: #0f172a;
            outline: none;
            transition: border-color 0.2s ease;
            min-width: 0; /* Allow input to shrink */
            box-sizing: border-box;
            /* Debug: Make input very visible */
            min-height: 40px;
            font-weight: 500;
        }

        .chat-input input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .chat-input input::placeholder {
            color: #94a3b8;
            font-weight: normal;
        }

        .btn-send {
            padding: 10px 16px;
            border: none;
            border-radius: 20px;
            background: #3b82f6;
            color: white;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .btn-send:hover {
            background: #2563eb;
        }

        /* Bottom Panel: Review Controls & Summary */
        .review-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: white;
            border-top: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            padding: 0 20px;
            transition: height 0.3s ease;
            z-index: 1000;
        }

        .review-panel.expanded {
            height: 250px;
        }

        .review-content {
            display: flex;
            width: 100%;
            height: 100%;
            align-items: center;
        }

        .review-summary {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .review-summary h4 {
            font-size: 14px;
            font-weight: 600;
            color: #0f172a;
        }

        .review-summary p {
            font-size: 12px;
            color: #64748b;
        }

        .review-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .btn-review {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            background: #10b981;
            color: white;
        }

        .btn-review:hover {
            background: #059669;
        }

        .btn-review:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .expand-toggle {
            position: absolute;
            top: -20px;
            right: 20px;
            width: 40px;
            height: 20px;
            background: white;
            border: 1px solid #e2e8f0;
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #64748b;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .chat-panel {
                width: 300px;
            }
        }

        @media (max-width: 1000px) {
            .po-explorer-panel {
                width: 200px;
            }
            
            .chat-panel {
                width: 250px;
            }
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Notification System */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            max-width: 400px;
            animation: slideInRight 0.3s ease-out;
        }

        .notification-content {
            background: white;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-left: 4px solid #3b82f6;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .notification-success .notification-content {
            border-left-color: #10b981;
        }

        .notification-error .notification-content {
            border-left-color: #ef4444;
        }

        .notification-warning .notification-content {
            border-left-color: #f59e0b;
        }

        .notification-info .notification-content {
            border-left-color: #3b82f6;
        }

        .notification-message {
            flex: 1;
            font-size: 14px;
            color: #0f172a;
        }

        .notification-close {
            background: none;
            border: none;
            font-size: 18px;
            color: #64748b;
            cursor: pointer;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .notification-close:hover {
            background: #f1f5f9;
            color: #0f172a;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Enhanced PO File Selection */
        .po-file-item.selected {
            background: #eff6ff;
            border-left-color: #3b82f6;
        }

        /* Enhanced Status Badges */
        .status-review {
            background: #fef3c7;
            color: #92400e;
        }

        .status-processing {
            background: #dbeafe;
            color: #1e40af;
        }

        .recommendation.pending {
            color: #f59e0b;
        }

        .recommendation.review {
            color: #f59e0b;
        }

        /* Enhanced Modal System */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            pointer-events: none; /* Allow clicks to pass through to underlying elements */
        }

        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: -1; /* Ensure it's behind other content */
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            color: #1e293b;
            font-size: 20px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #64748b;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: #f1f5f9;
            color: #475569;
        }

        .modal-body {
            padding: 24px;
        }

        .detail-section {
            margin-bottom: 24px;
        }

        .detail-section h4 {
            margin: 0 0 16px 0;
            color: #1e293b;
            font-size: 16px;
            font-weight: 600;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 8px;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .detail-item {
            padding: 12px;
            background: #f8fafc;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }

        .po-match-item {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .po-match-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e2e8f0;
        }

        .match-score {
            background: #3b82f6;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .po-match-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 8px;
            font-size: 14px;
            color: #475569;
        }

        .match-reasons {
            margin-top: 8px;
            padding: 8px;
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 4px;
            font-size: 12px;
            color: #0369a1;
        }

        .no-matches {
            text-align: center;
            padding: 24px;
            color: #64748b;
            font-style: italic;
            background: #f8fafc;
            border: 1px dashed #cbd5e1;
            border-radius: 6px;
        }

        .ai-analysis {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 16px;
            max-height: 300px;
            overflow-y: auto;
        }

        .analysis-line {
            margin-bottom: 8px;
            padding: 4px 0;
            font-size: 14px;
            line-height: 1.5;
        }

        .recommendation-reason {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 6px;
            padding: 16px;
            color: #166534;
            font-size: 14px;
            line-height: 1.6;
        }

        /* Progress Bar Enhancements */
        #importProgress {
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* File Type Icons */
        .file-type-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            margin-right: 8px;
            vertical-align: middle;
        }

        .file-type-pdf::before { content: "📄"; }
        .file-type-txt::before { content: "📝"; }
        .file-type-html::before { content: "🌐"; }
        .file-type-doc::before { content: "📘"; }
        .file-type-docx::before { content: "📘"; }

        .po-matches {
            font-size: 12px;
            font-weight: 500;
            padding: 4px 8px;
            border-radius: 12px;
            text-align: center;
            min-width: 40px;
        }

        .po-matches.has-matches {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .po-matches.no-matches {
            background: #fef2f2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Left Panel: PO Files Explorer -->
        <div class="po-explorer-panel" id="poExplorerPanel">
            <div class="resize-handle" onmousedown="startResize(event, 'poExplorerPanel', 'right')"></div>
            <div class="panel-header">
                <h2>PO Files Explorer</h2>
                <div class="subtitle">Purchase Order Management</div>
                
                <div class="folder-selector">
                    <div style="margin-bottom: 8px;">
                        <label for="poFolderPath" style="font-size: 11px; color: #64748b; display: block; margin-bottom: 4px;">
                            PO Files Selection
                        </label>
                        <input type="text" class="folder-input" id="poFolderPath" placeholder="Selected files will appear here" value="" readonly />
                    </div>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="btn-small" onclick="selectPOFiles()" title="Select individual PO files">
                            📁 Select Files
                        </button>
                        <button class="btn-small" onclick="selectPOFolder()" title="Select entire folder for batch processing">
                            📂 Select Folder
                        </button>
                        <button class="btn-small" onclick="scanPOFolder()" title="Scan selected folder for PO files">
                            🔍 Scan Folder
                        </button>
                        <button class="btn-small" onclick="processPOFiles()" title="Process selected PO files">
                            ⚡ Process
                        </button>
                        <button class="btn-small" onclick="processPOFilesFallback()" title="Process PO files with fallback method (no AI)" style="background: #f59e0b;">
                            🔧 Fallback
                        </button>
                        <button class="btn-small" onclick="clearPOSelection()" title="Clear all selected PO files" style="background: #ef4444;">
                            🗑️ Clear
                        </button>
                        <button class="btn-small" onclick="selectCommonFolder()" title="Select from common sample folders" style="background: #10b981;">
                            📂 Quick Select
                        </button>
                    </div>
                    
                    <!-- Hidden file inputs for selection -->
                    <input type="file" id="poFileInput" multiple accept=".pdf,.txt,.html,.doc,.docx" style="display: none;" onchange="handlePOFileSelection(event)" />
                    <input type="file" id="folderInput" webkitdirectory directory multiple style="display: none;" onchange="handleFolderSelection(event)" />
                </div>
                
                <div class="po-stats">
                    <div class="stat-item">
                        <div class="stat-number" id="totalPOs">0</div>
                        <div class="stat-label">Total</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="processedPOs">0</div>
                        <div class="stat-label">Processed</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="pendingPOs">0</div>
                        <div class="stat-label">Pending</div>
                    </div>
                </div>
            </div>
            
            <div class="po-file-list" id="poFileList">
                <!-- PO files will be populated here -->
            </div>
        </div>

        <!-- Center Panel: Invoice Management -->
        <div class="invoice-panel" id="invoicePanel">
            <div class="resize-handle" onmousedown="startResize(event, 'invoicePanel', 'right')"></div>
            <div class="invoice-header">
                <h3>Invoice Management</h3>
                <div class="invoice-controls">
                    <button class="btn-primary" onclick="importInvoices()">Import Invoices</button>
                    <button class="btn-primary" onclick="selectAllInvoices()">Select All</button>
                    <button class="btn-primary" onclick="deselectAllInvoices()">Deselect All</button>
                    <button class="btn-primary" onclick="refreshInvoices()">Refresh</button>
                    <button class="btn-primary" onclick="processSelected()">Process Selected</button>
                    <button class="btn-primary" onclick="bulkApprove()">Bulk Approve</button>
                </div>
            </div>
            
            <div class="invoice-table">
                <div class="invoice-table-header">
                    <div>Select</div>
                    <div>Invoice ID</div>
                    <div>Vendor</div>
                    <div>Amount</div>
                    <div>Date</div>
                    <div>Status</div>
                    <div>Recommendation</div>
                    <div>PO Matches</div>
                    <div>Actions</div>
                </div>
                
                <div class="invoice-table-body" id="invoiceTableBody">
                    <!-- Invoice rows will be populated here -->
                </div>
            </div>
        </div>

        <!-- Right Panel: AI Chat Interface -->
        <div class="chat-panel" id="chatPanel">
            <div class="resize-handle" onmousedown="startResize(event, 'chatPanel', 'left')"></div>
            <div class="chat-header">
                <h2>AI Assistant</h2>
                <div class="chat-status">● Online</div>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <div class="message assistant">
                    <div class="message-bubble">
                        Hello! I'm your AI assistant for invoice processing. I can help you understand recommendations, explain matches, and answer questions about your POs and invoices.
                    </div>
                    <div class="message-time">Just now</div>
                </div>
            </div>
            
            <div class="quick-actions">
                <h4>Quick Actions</h4>
                <div class="action-buttons">
                    <button class="btn-action" onclick="explainRecommendation()">Explain this recommendation</button>
                    <button class="btn-action" onclick="showPOMatches()">What POs match this invoice?</button>
                    <button class="btn-action" onclick="showCalculationDetails()">Show calculation details</button>
                    <button class="btn-action" onclick="overrideRecommendation()">Override recommendation</button>
                </div>
            </div>
            
            <div class="chat-input">
                <div class="chat-input-container">
                    <input type="text" id="chatInput" placeholder="Ask me anything about your invoices..." />
                    <button class="btn-send" onclick="sendMessage()">Send</button>
                    <button class="btn-send" onclick="testChatInput()" style="background: #f59e0b;">Test</button>
                </div>
                <div style="font-size: 10px; color: #64748b; margin-top: 8px; text-align: center;">
                    Debug: Chat input should be visible above
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Panel: Review Controls & Summary -->
    <div class="review-panel" id="reviewPanel">
        <div class="expand-toggle" onclick="toggleReviewPanel()">▼</div>
        <div class="review-content">
            <div class="review-summary">
                <h4>Selected Invoice Summary</h4>
                <p id="selectedInvoiceSummary">No invoice selected</p>
            </div>
            
            <div class="review-actions">
                <button class="btn-review" id="reviewButton" onclick="reviewInvoices()" disabled>
                    Review Invoices (0 selected)
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentPOFiles = [];
        let currentInvoices = [];
        let selectedInvoices = new Set();
        let chatHistory = [];

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        // Clear storage and load fresh data on page load
        function initializeApp() {
            clearInvoiceStorage(); // Clear old data
            loadPOFiles();
            loadInvoices(); // This will now start fresh
            
            // Set up event listeners
            setupEventListeners();
        }

        function setupEventListeners() {
            // Chat input enter key
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
                
                // Debug: Log that chat input is found
                console.log('Chat input found and initialized:', chatInput);
                console.log('Chat input styles:', window.getComputedStyle(chatInput));
            } else {
                console.error('Chat input element not found!');
            }

            // Update selected invoice summary when invoice selection changes
            document.querySelectorAll('.table-row').forEach(row => {
                row.addEventListener('click', function() {
                    const checkbox = this.querySelector('.checkbox');
                    if (checkbox) {
                        toggleInvoiceSelection(this.dataset.invoiceId);
                    }
                });
            });
        }

        // PO Files Management
        function selectPOFiles() {
            const fileInput = document.getElementById('poFileInput');
            fileInput.click(); // Trigger file picker for individual files
        }

        function handlePOFileSelection(event) {
            const files = Array.from(event.target.files);
            if (files.length === 0) {
                showNotification('No PO files selected.', 'warning');
                return;
            }

            // Validate file types
            const validFiles = files.filter(file => {
                const extension = file.name.toLowerCase().split('.').pop();
                const validExtensions = ['pdf', 'txt', 'html', 'doc', 'docx'];
                return validExtensions.includes(extension);
            });

            if (validFiles.length === 0) {
                showNotification('No valid PO files selected. Supported formats: PDF, TXT, HTML, DOC, DOCX', 'error');
                return;
            }

            if (validFiles.length !== files.length) {
                const invalidCount = files.length - validFiles.length;
                showNotification(`${invalidCount} file(s) were skipped due to unsupported format`, 'warning');
            }

            // Convert files to PO file format
            currentPOFiles = validFiles.map(file => ({
                name: file.name,
                size: file.size,
                modified: file.lastModified,
                extension: '.' + file.name.toLowerCase().split('.').pop(),
                full_path: file.name, // Use filename as path for individual files
                status: 'pending',
                file: file // Store the actual file object for processing
            }));

            // Update the display
            const fileNames = validFiles.map(f => f.name).join(', ');
            document.getElementById('poFolderPath').value = `${validFiles.length} file(s) selected: ${fileNames}`;
            
            showNotification(`Selected ${validFiles.length} PO files for processing`, 'success');
            
            // Update the file list and stats
            updatePOFileList();
            updatePOStats();
            
            // Clear the input to allow re-selection
            event.target.value = '';
        }

        async function selectPOFolder() {
            const folderInput = document.getElementById('folderInput');
            folderInput.click(); // Trigger native folder picker
        }

        function handleFolderSelection(event) {
            const files = event.target.files;
            if (files.length === 0) {
                showNotification('No folder selected.', 'warning');
                return;
            }

            // Get the folder path from the first file
            const firstFile = files[0];
            let folderPath = '';
            
            // Extract folder path from file path
            if (firstFile.webkitRelativePath) {
                // Chrome/Safari: webkitRelativePath contains the full path
                const pathParts = firstFile.webkitRelativePath.split('/');
                if (pathParts.length > 1) {
                    folderPath = pathParts[0]; // First part is the folder name
                }
            } else if (firstFile.path) {
                // Electron: path contains the full file path
                const pathParts = firstFile.path.split('/');
                if (pathParts.length > 1) {
                    // Remove the filename and get the directory
                    pathParts.pop();
                    folderPath = pathParts.join('/');
                }
            } else {
                // Fallback: try to get folder name from file name
                folderPath = firstFile.name.split('/')[0];
            }

            if (folderPath) {
                // For now, let's use the folder name and construct the path relative to sample_data
                // This handles the case where the native picker only gives us the folder name
                let finalPath = folderPath;
                
                // If it's a subfolder of sample_data, construct the full path
                if (folderPath === 'Sample PO - pdf' || folderPath === 'Sample INV - pdf' || 
                    folderPath === 'Sample PO - html' || folderPath === 'Sample INV - html') {
                    finalPath = `sample_data/${folderPath}`;
                } else if (folderPath === 'sample_data') {
                    finalPath = folderPath;
                } else {
                    // For other folders, try to construct a path
                    finalPath = folderPath;
                }
                
                document.getElementById('poFolderPath').value = finalPath;
                showNotification(`Selected folder: ${finalPath}`, 'info');
                
                // Clear the input to allow re-selection
                event.target.value = '';
                
                // Automatically scan the selected folder
                setTimeout(() => scanPOFolder(), 500);
            } else {
                showNotification('Could not determine folder path. Please try again.', 'error');
            }
        }

        async function scanPOFolder() {
            const folderPath = document.getElementById('poFolderPath').value.trim();
            if (!folderPath) {
                showNotification('Please enter or select a folder path first', 'error');
                return;
            }

            showNotification(`Scanning folder: ${folderPath}`, 'info');
            
            try {
                const response = await fetch('/api/v1/folder-monitoring/scan-folder', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ folder_path: folderPath })
                });

                if (response.ok) {
                    const result = await response.json();
                    displayPOFiles(result.scan_results);
                    updatePOStats();
                    showNotification(`Found ${result.scan_results.files.length} files in ${folderPath}`, 'success');
                } else {
                    const errorText = await response.text();
                    let errorMessage = `Error scanning folder: ${errorText}`;
                    
                    // Provide helpful suggestions for common errors
                    if (errorText.includes('Folder does not exist')) {
                        errorMessage += '\n\nTry using the "📂 Quick Select" button to choose from common folders, or check that the path is correct.';
                    }
                    
                    showNotification(errorMessage, 'error');
                }
            } catch (error) {
                showNotification(`Network error: ${error.message}`, 'error');
            }
        }

        async function processPOFiles() {
            if (currentPOFiles.length === 0) {
                showNotification('No PO files to process', 'warning');
                return;
            }

            // Check if we have individual files or folder-based files
            const hasIndividualFiles = currentPOFiles.some(f => f.file);
            const hasFolderPath = currentPOFiles.some(f => f.full_path && !f.file);

            if (hasIndividualFiles) {
                // Process individual files directly
                showNotification('Processing individual PO files...', 'info');
                await processIndividualPOFiles();
            } else if (hasFolderPath) {
                // Process folder-based files using API
                await processFolderBasedPOFiles();
            } else {
                showNotification('No valid files to process', 'error');
            }
        }

        // Process individual files directly (no API needed)
        async function processIndividualPOFiles() {
            for (let i = 0; i < currentPOFiles.length; i++) {
                const file = currentPOFiles[i];
                
                // Update status to processing
                file.status = 'processing';
                updatePOFileList();
                
                // Simulate processing delay
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Generate mock PO data for demonstration
                const mockPOData = generateMockPOData(file.name);
                
                // Update file with mock results
                file.status = 'processed';
                file.result = {
                    po_number: mockPOData.po_number,
                    vendor_name: mockPOData.vendor_name,
                    total_amount: mockPOData.total_amount,
                    po_date: mockPOData.po_date
                };
                
                updatePOFileList();
                updatePOStats();
            }
            
            showNotification('Individual PO files processed successfully!', 'success');
        }

        // Process folder-based files using API
        async function processFolderBasedPOFiles() {
            const folderPath = document.getElementById('poFolderPath').value;
            if (!folderPath || !folderPath.includes('sample_data')) {
                showNotification('Please select a valid folder first', 'error');
                return;
            }

            showNotification('Processing folder-based PO files...', 'info');
            
            try {
                const response = await fetch('/api/v1/folder-monitoring/batch-process', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ folder_path: folderPath })
                });

                if (response.ok) {
                    const result = await response.json();
                    updatePOFilesFromBatchResult(result);
                    
                    // Show detailed results
                    const summary = result.summary || {};
                    const message = `Processing complete!\n\n` +
                        `✅ Successful: ${summary.successful || 0}\n` +
                        `⏭️ Skipped: ${summary.skipped || 0}\n` +
                        `❌ Failed: ${summary.failed || 0}`;
                    
                    showNotification(message, 'success');
                    
                    // Update stats immediately
                    updatePOStats();
                } else {
                    const errorText = await response.text();
                    console.error('PO Processing Error:', errorText);
                    
                    // Check if it's an AI quota issue
                    if (errorText.includes('quota') || errorText.includes('429') || errorText.includes('insufficient_quota')) {
                        showNotification('AI processing failed due to quota limits. Using fallback processing...', 'warning');
                        
                        // Use fallback processing
                        await processPOFilesFallback();
                    } else {
                        showNotification(`Error processing files: ${errorText}`, 'error');
                    }
                }
            } catch (error) {
                console.error('PO Processing Network Error:', error);
                showNotification(`Network error: ${error.message}. Using fallback processing...`, 'warning');
                
                // Use fallback processing
                await processPOFilesFallback();
            }
        }

        // Fallback PO processing when AI is unavailable
        async function processPOFilesFallback() {
            if (currentPOFiles.length === 0) {
                showNotification('No PO files to process', 'warning');
                return;
            }

            showNotification('Processing PO files with fallback method...', 'info');
            
            // Check if we have individual files or folder-based files
            const hasIndividualFiles = currentPOFiles.some(f => f.file);
            
            if (hasIndividualFiles) {
                // Process individual files directly
                await processIndividualPOFiles();
            } else {
                // Process folder-based files with fallback
                for (let i = 0; i < currentPOFiles.length; i++) {
                    const file = currentPOFiles[i];
                    
                    // Update status to processing
                    file.status = 'processing';
                    updatePOFileList();
                    
                    // Simulate processing delay
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    // Generate mock PO data for demonstration
                    const mockPOData = generateMockPOData(file.name);
                    
                    // Update file with mock results
                    file.status = 'processed';
                    file.result = {
                        po_number: mockPOData.po_number,
                        vendor_name: mockPOData.vendor_name,
                        total_amount: mockPOData.total_amount,
                        po_date: mockPOData.po_date
                    };
                    
                    updatePOFileList();
                    updatePOStats();
                }
                
                showNotification('Fallback processing complete! (Using mock data for demonstration)', 'success');
            }
        }

        // Generate mock PO data for demonstration
        function generateMockPOData(filename) {
            const vendors = [
                'Acme Construction Supply Co.',
                'Builders Warehouse & Supply',
                'Construction Materials Plus',
                'Professional Building Supplies',
                'Quality Construction Tools',
                'Industrial Supply Solutions'
            ];
            
            const amounts = [1250.00, 875.50, 2100.00, 3450.75, 1899.99, 2750.25];
            
            // Extract PO number from filename if possible
            let poNumber = 'PO-2024-001';
            if (filename.includes('PO-')) {
                const match = filename.match(/PO-\d+-\d+/);
                if (match) poNumber = match[0];
            }
            
            return {
                po_number: poNumber,
                vendor_name: vendors[Math.floor(Math.random() * vendors.length)],
                total_amount: amounts[Math.floor(Math.random() * amounts.length)],
                po_date: new Date().toISOString().split('T')[0]
            };
        }

        function updatePOFilesFromBatchResult(batchResult) {
            if (!batchResult) return;

            const processedFiles = batchResult.processed_files || [];
            const skippedFiles = batchResult.skipped_files || [];
            const errors = batchResult.errors || [];

            console.log('Batch result:', batchResult); // Debug logging

            // Create a map of results by filename
            const resultsMap = new Map();
            
            processedFiles.forEach(file => {
                resultsMap.set(file.name, { status: 'processed', ...file });
            });
            
            skippedFiles.forEach(file => {
                resultsMap.set(file.name, { status: 'skipped', ...file });
            });
            
            errors.forEach(file => {
                resultsMap.set(file.name, { status: 'error', ...file });
            });

            // Update current PO files with results
            currentPOFiles.forEach(file => {
                const result = resultsMap.get(file.name);
                if (result) {
                    file.status = result.status;
                    file.result = result;
                    console.log(`Updated ${file.name} to status: ${result.status}`); // Debug logging
                }
            });

            updatePOFileList();
            updatePOStats();
        }

        function displayPOFiles(scanResults) {
            if (!scanResults || !scanResults.files) {
                currentPOFiles = [];
                updatePOFileList();
                return;
            }

            console.log('Displaying PO files:', scanResults.files); // Debug logging

            currentPOFiles = scanResults.files.map(file => ({
                ...file,
                status: 'pending' // Default status
            }));

            console.log('Current PO files after mapping:', currentPOFiles); // Debug logging

            updatePOFileList();
        }

        function updatePOFileList() {
            const fileList = document.getElementById('poFileList');
            fileList.innerHTML = '';

            if (currentPOFiles.length === 0) {
                fileList.innerHTML = '<div style="text-align: center; color: #64748b; padding: 20px;">No PO files found</div>';
                return;
            }

            console.log('Updating PO file list with:', currentPOFiles); // Debug logging

            currentPOFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = `po-file-item ${file.status}`;
                fileItem.onclick = () => selectPOFile(index);
                
                let detailsText = `${(file.size / 1024).toFixed(1)} KB`;
                
                if (file.result) {
                    if (file.status === 'processed' && file.result.po_number) {
                        detailsText = `PO: ${file.result.po_number} | Vendor: ${file.result.vendor_name}`;
                    } else if (file.status === 'skipped' && file.result.reason) {
                        detailsText = `Skipped: ${file.result.reason}`;
                    } else if (file.result.error) {
                        detailsText = `Error: ${file.result.error}`;
                    }
                }
                
                fileItem.innerHTML = `
                    <div class="po-file-name">${file.name}</div>
                    <div class="po-file-details">${detailsText}</div>
                    <div class="po-file-status">${file.status}</div>
                `;
                
                fileList.appendChild(fileItem);
            });
        }

        function updatePOStats() {
            const stats = {
                total: currentPOFiles.length,
                processed: currentPOFiles.filter(f => f.status === 'processed').length,
                pending: currentPOFiles.filter(f => f.status === 'pending').length,
                skipped: currentPOFiles.filter(f => f.status === 'skipped').length,
                error: currentPOFiles.filter(f => f.status === 'error').length
            };

            console.log('PO Stats:', stats); // Debug logging

            document.getElementById('totalPOs').textContent = stats.total;
            document.getElementById('processedPOs').textContent = stats.processed;
            document.getElementById('pendingPOs').textContent = stats.pending;
            
            // Add skipped and error counts to the display
            const statsContainer = document.querySelector('.po-stats');
            if (statsContainer) {
                // Update existing stat items or add new ones
                let skippedElement = statsContainer.querySelector('.stat-skipped');
                let errorElement = statsContainer.querySelector('.stat-error');
                
                if (!skippedElement) {
                    skippedElement = document.createElement('div');
                    skippedElement.className = 'stat-item stat-skipped';
                    skippedElement.innerHTML = `
                        <div class="stat-number">0</div>
                        <div class="stat-label">Skipped</div>
                    `;
                    statsContainer.appendChild(skippedElement);
                }
                
                if (!errorElement) {
                    errorElement = document.createElement('div');
                    errorElement.className = 'stat-item stat-error';
                    errorElement.innerHTML = `
                        <div class="stat-number">0</div>
                        <div class="stat-label">Errors</div>
                    `;
                    statsContainer.appendChild(errorElement); // Fixed: was appending skippedElement
                }
                
                // Update the values
                skippedElement.querySelector('.stat-number').textContent = stats.skipped;
                errorElement.querySelector('.stat-number').textContent = stats.error;
            }
        }

        function selectPOFile(index) {
            const file = currentPOFiles[index];
            if (!file) return;

            // Update chat context
            addChatMessage('assistant', `Selected PO file: ${file.name}\n\nSize: ${(file.size / 1024).toFixed(1)} KB\nStatus: ${file.status}${file.result ? '\n' + JSON.stringify(file.result, null, 2) : ''}`);
            
            // Highlight selected file
            document.querySelectorAll('.po-file-item').forEach(item => item.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
        }

        // Notification System
        function showNotification(message, type = 'info') {
            // Remove existing notifications
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(n => n.remove());

            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <span class="notification-message">${message}</span>
                    <button class="notification-close" onclick="this.parentElement.parentElement.remove()">×</button>
                </div>
            `;

            document.body.appendChild(notification);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        // Invoice Management with Real Data
        async function loadInvoices() {
            // Clear existing invoices on server restart
            currentInvoices = [];
            
            try {
                const response = await fetch('/api/v1/invoices/');
                if (response.ok) {
                    const invoices = await response.json();
                    // Only update if we actually got invoices from the API
                    if (invoices && invoices.length > 0) {
                        currentInvoices = invoices.map(invoice => ({
                            id: invoice.id || invoice.invoice_number,
                            vendor: invoice.vendor_name || 'Unknown Vendor',
                            amount: parseFloat(invoice.total_amount) || 0,
                            date: invoice.invoice_date || 'Unknown Date',
                            status: invoice.status || 'pending',
                            recommendation: invoice.recommendation || 'pending',
                            po_matches: invoice.po_matches || [],
                            confidence: invoice.confidence_score || 0,
                            fileInfo: invoice.file_info || null
                        }));
                        // Save to local storage
                        saveInvoicesToStorage();
                    } else {
                        // API returned empty list, start fresh
                        console.log('API returned empty invoice list, starting fresh');
                        currentInvoices = [];
                    }
                } else {
                    // API failed, start fresh
                    console.log('API failed to load invoices, starting fresh');
                    currentInvoices = [];
                }
            } catch (error) {
                console.log('Using fresh invoice data:', error.message);
                // Start with empty list on error
                currentInvoices = [];
            }

            updateInvoiceTable();
        }

        async function importInvoices() {
            // Create file input for multiple invoice files
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.multiple = true;
            fileInput.accept = '.pdf,.txt,.html,.doc,.docx';
            
            fileInput.onchange = async (event) => {
                const files = Array.from(event.target.files);
                if (files.length === 0) return;

                // Validate file types
                const validFiles = files.filter(file => {
                    const extension = file.name.toLowerCase().split('.').pop();
                    const validExtensions = ['pdf', 'txt', 'html', 'doc', 'docx'];
                    return validExtensions.includes(extension);
                });

                if (validFiles.length === 0) {
                    showNotification('No valid invoice files selected. Supported formats: PDF, TXT, HTML, DOC, DOCX', 'error');
                    return;
                }

                if (validFiles.length !== files.length) {
                    const invalidCount = files.length - validFiles.length;
                    showNotification(`${invalidCount} file(s) were skipped due to unsupported format`, 'warning');
                }

                showNotification(`Importing ${validFiles.length} invoice files...`, 'info');
                
                // Show import progress
                const progressMessage = document.createElement('div');
                progressMessage.id = 'importProgress';
                progressMessage.innerHTML = `
                    <div style="background: #f8fafc; padding: 16px; border-radius: 8px; margin: 16px 0;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>Importing invoices...</span>
                            <span id="importCount">0 / ${validFiles.length}</span>
                        </div>
                        <div style="background: #e2e8f0; height: 4px; border-radius: 2px; overflow: hidden;">
                            <div id="importProgressBar" style="background: #3b82f6; height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                        </div>
                    </div>
                `;
                
                // Insert progress bar after the invoice header
                const invoiceHeader = document.querySelector('.invoice-header');
                invoiceHeader.appendChild(progressMessage);
                
                // Process files with progress tracking
                for (let i = 0; i < validFiles.length; i++) {
                    const file = validFiles[i];
                    
                    // Update progress
                    const progressBar = document.getElementById('importProgressBar');
                    const progressCount = document.getElementById('importCount');
                    const progress = ((i + 1) / validFiles.length) * 100;
                    
                    if (progressBar) progressBar.style.width = `${progress}%`;
                    if (progressCount) progressCount.textContent = `${i + 1} / ${validFiles.length}`;
                    
                    // Process the file
                    await simulateInvoiceProcessing(file);
                    
                    // Small delay to show progress
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
                
                // Remove progress bar
                if (progressMessage.parentElement) {
                    progressMessage.remove();
                }
                
                showNotification(`Successfully imported ${validFiles.length} invoices`, 'success');
                // Don't reload invoices from API - keep the newly imported ones
                // loadInvoices(); // This was causing invoices to disappear
                
                // Clear the file input
                event.target.value = '';
            };
            
            fileInput.click();
        }

        async function simulateInvoiceProcessing(file) {
            return new Promise(resolve => {
                setTimeout(() => {
                    // Generate realistic invoice data based on file type
                    const fileExtension = file.name.toLowerCase().split('.').pop();
                    const fileSize = (file.size / 1024).toFixed(1); // Size in KB
                    
                    // Create more realistic vendor names based on file type
                    const vendorNames = [
                        'Acme Construction Supply Co.',
                        'Builders Warehouse & Supply',
                        'Construction Materials Plus',
                        'Professional Building Supplies',
                        'Quality Construction Tools',
                        'Industrial Supply Solutions',
                        'Contractor Equipment Co.',
                        'Building Materials Express',
                        'Construction Supply Depot',
                        'Professional Tools & Materials'
                    ];
                    
                    // Create realistic amounts based on construction industry
                    const realisticAmounts = [
                        1250.00, 875.50, 2100.00, 3450.75, 1899.99,
                        2750.25, 1560.80, 4200.00, 950.25, 3100.50,
                        1850.75, 2650.00, 1450.25, 3800.00, 2200.75
                    ];
                    
                    // Add new invoice to the list
                    const newInvoice = {
                        id: file.name.replace(/\.[^/.]+$/, ""), // Use filename without extension as ID
                        vendor: vendorNames[Math.floor(Math.random() * vendorNames.length)],
                        amount: realisticAmounts[Math.floor(Math.random() * realisticAmounts.length)],
                        date: new Date().toISOString().split('T')[0],
                        status: 'processing',
                        recommendation: 'pending',
                        po_matches: [],
                        confidence: 0,
                        fileInfo: {
                            name: file.name,
                            size: fileSize,
                            type: fileExtension.toUpperCase(),
                            uploadedAt: new Date().toISOString()
                        }
                    };
                    
                    // Add to beginning of list for better visibility
                    currentInvoices.unshift(newInvoice);
                    updateInvoiceTable();
                    
                    // Save to local storage
                    saveInvoicesToStorage();
                    
                    // Show individual file processing notification
                    showNotification(`Processed: ${file.name} (${fileSize} KB)`, 'success');
                    
                    resolve();
                }, 1000 + Math.random() * 2000); // Random delay between 1-3 seconds
            });
        }

        async function processSelected() {
            if (selectedInvoices.size === 0) {
                showNotification('Please select invoices to process first.', 'warning');
                return;
            }

            // Check if POs have been processed first
            const processedPOs = currentPOFiles.filter(f => f.status === 'processed').length;
            const totalPOs = currentPOFiles.length;
            
            if (totalPOs > 0 && processedPOs === 0) {
                // Show warning popup
                const shouldContinue = confirm(
                    `⚠️ WARNING: Purchase Orders Not Processed\n\n` +
                    `Found ${totalPOs} PO files, but none have been processed yet.\n\n` +
                    `Processing invoices without processed POs may result in:\n` +
                    `• No PO matches found\n` +
                    `• Inaccurate recommendations\n` +
                    `• Manual review required\n\n` +
                    `Do you want to:\n` +
                    `• Continue processing invoices anyway?\n` +
                    `• Process POs first (recommended)?\n\n` +
                    `Click OK to continue with invoices, Cancel to process POs first.`
                );
                
                if (!shouldContinue) {
                    showNotification('Please process PO files first for better invoice matching.', 'info');
                    return;
                }
            }

            const selectedInvoiceIds = Array.from(selectedInvoices);
            showNotification(`Processing ${selectedInvoiceIds.length} selected invoices...`, 'info');

            // Simulate processing each invoice
            for (const invoiceId of selectedInvoiceIds) {
                const invoice = currentInvoices.find(inv => inv.id === invoiceId);
                if (invoice) {
                    invoice.status = 'processing';
                    updateInvoiceTable();
                    
                    // Simulate AI processing
                    await simulateAIProcessing(invoice);
                }
            }

            showNotification(`Successfully processed ${selectedInvoiceIds.length} invoices`, 'success');
            updateInvoiceTable();
        }

        async function simulateAIProcessing(invoice) {
            return new Promise(resolve => {
                setTimeout(() => {
                    // Find matching POs for this invoice
                    const poMatches = findMatchingPOs(invoice);
                    invoice.po_matches = poMatches;
                    
                    // AI Analysis and Recommendation Generation
                    const analysis = generateAIAnalysis(invoice, poMatches);
                    
                    // Update invoice with AI results
                    invoice.confidence = analysis.confidence;
                    invoice.recommendation = analysis.recommendation;
                    invoice.status = analysis.status;
                    invoice.ai_analysis = analysis.analysis;
                    invoice.recommendation_reason = analysis.reason;
                    
                    // Save to local storage
                    saveInvoicesToStorage();
                    
                    resolve();
                }, 2000 + Math.random() * 3000); // Random delay between 2-5 seconds
            });
        }

        function generateAIAnalysis(invoice, poMatches) {
            let confidence = 0;
            let recommendation = 'pending';
            let status = 'pending';
            let analysis = [];
            let reason = '';
            
            // PO Matching Analysis
            if (poMatches.length > 0) {
                const bestMatch = poMatches[0];
                confidence = Math.min(0.95, bestMatch.match_score + 0.1);
                
                analysis.push(`✅ Found ${poMatches.length} matching purchase order(s)`);
                analysis.push(`📊 Best match: PO ${bestMatch.po_number} (${(bestMatch.match_score * 100).toFixed(1)}% confidence)`);
                analysis.push(`🏢 Vendor: ${bestMatch.vendor_name}`);
                analysis.push(`💰 PO Amount: $${bestMatch.total_amount.toFixed(2)}`);
                analysis.push(`📅 PO Date: ${bestMatch.po_date}`);
                
                // Amount validation
                const amountDiff = Math.abs(invoice.amount - bestMatch.total_amount);
                const amountPercentage = (amountDiff / bestMatch.total_amount) * 100;
                
                if (amountPercentage <= 5) {
                    analysis.push(`✅ Amount within 5% tolerance (${amountPercentage.toFixed(1)}% difference)`);
                    confidence += 0.1;
                } else if (amountPercentage <= 10) {
                    analysis.push(`⚠️ Amount within 10% tolerance (${amountPercentage.toFixed(1)}% difference)`);
                    confidence += 0.05;
                } else if (amountPercentage <= 20) {
                    analysis.push(`⚠️ Amount within 20% tolerance (${amountPercentage.toFixed(1)}% difference)`);
                    confidence = Math.max(0.3, confidence - 0.1);
                } else {
                    analysis.push(`❌ Amount exceeds 20% tolerance (${amountPercentage.toFixed(1)}% difference)`);
                    confidence = Math.max(0.2, confidence - 0.3);
                }
                
                // Date validation
                const invoiceDate = new Date(invoice.date);
                const poDate = new Date(bestMatch.po_date);
                const dayDiff = Math.abs(invoiceDate.getTime() - poDate.getTime()) / (1000 * 60 * 60 * 24);
                
                if (dayDiff <= 30) {
                    analysis.push(`✅ Invoice date within 30 days of PO date`);
                    confidence += 0.05;
                } else if (dayDiff <= 90) {
                    analysis.push(`⚠️ Invoice date within 90 days of PO date`);
                    confidence = Math.max(0.3, confidence - 0.05);
                } else {
                    analysis.push(`❌ Invoice date more than 90 days from PO date`);
                    confidence = Math.max(0.2, confidence - 0.15);
                }
                
                // Match reasons
                if (bestMatch.match_reasons) {
                    analysis.push(`🔍 Match details: ${bestMatch.match_reasons.join(', ')}`);
                }
                
            } else {
                analysis.push(`❌ No matching purchase orders found`);
                analysis.push(`🔍 Searched through ${currentPOFiles.filter(f => f.status === 'processed').length} processed POs`);
                confidence = Math.random() * 0.3; // Low confidence without PO matches
            }
            
            // Business Rules Analysis
            analysis.push(`\n📋 Business Rules Analysis:`);
            
            if (invoice.amount > 10000) {
                analysis.push(`⚠️ High amount (>$10,000) - Requires additional review`);
                confidence *= 0.7;
            } else if (invoice.amount > 5000) {
                analysis.push(`⚠️ Medium amount (>$5,000) - Standard review required`);
                confidence *= 0.85;
            } else {
                analysis.push(`✅ Standard amount (≤$5,000) - Normal processing`);
            }
            
            // Vendor Analysis
            if (poMatches.length > 0) {
                const bestMatch = poMatches[0];
                if (bestMatch.vendor_name.toLowerCase().includes('construction') || 
                    bestMatch.vendor_name.toLowerCase().includes('building') ||
                    bestMatch.vendor_name.toLowerCase().includes('supply')) {
                    analysis.push(`✅ Vendor type: Construction/Supply (expected for this PO)`);
                    confidence += 0.05;
                }
            }
            
            // Final Recommendation
            if (confidence > 0.8 && poMatches.length > 0) {
                recommendation = 'approved';
                status = 'approved';
                reason = `High confidence (${(confidence * 100).toFixed(1)}%) with strong PO match. Amount and vendor validation passed.`;
            } else if (confidence > 0.6) {
                recommendation = 'review';
                status = 'review';
                reason = `Medium confidence (${(confidence * 100).toFixed(1)}%). ${poMatches.length > 0 ? 'PO match found but requires manual review.' : 'No PO match - manual review required.'}`;
            } else {
                recommendation = 'rejected';
                status = 'rejected';
                reason = `Low confidence (${(confidence * 100).toFixed(1)}%). ${poMatches.length > 0 ? 'PO match found but validation failed.' : 'No PO match and validation failed.'}`;
            }
            
            // Add final analysis
            analysis.push(`\n🎯 Final Analysis:`);
            analysis.push(`Confidence Score: ${(confidence * 100).toFixed(1)}%`);
            analysis.push(`Recommendation: ${recommendation.toUpperCase()}`);
            analysis.push(`Reason: ${reason}`);
            
            return {
                confidence: confidence,
                recommendation: recommendation,
                status: status,
                analysis: analysis,
                reason: reason
            };
        }

        function updateInvoiceTable() {
            const tableBody = document.getElementById('invoiceTableBody');
            tableBody.innerHTML = '';

            if (currentInvoices.length === 0) {
                const noInvoicesRow = document.createElement('div');
                noInvoicesRow.className = 'table-row';
                noInvoicesRow.style.gridColumn = '1 / -1';
                noInvoicesRow.style.textAlign = 'center';
                noInvoicesRow.style.padding = '40px';
                noInvoicesRow.style.color = '#64748b';
                noInvoicesRow.textContent = 'No invoices found';
                tableBody.appendChild(noInvoicesRow);
                return;
            }

            currentInvoices.forEach((invoice, index) => {
                const row = document.createElement('div');
                row.className = `table-row ${selectedInvoices.has(invoice.id) ? 'selected' : ''}`;
                row.onclick = () => toggleInvoiceSelection(invoice.id);
                row.dataset.invoiceId = invoice.id; // Add data attribute for event listener
                
                const statusClass = invoice.status === 'approved' ? 'approved' : 
                                  invoice.status === 'rejected' ? 'rejected' : 'pending';
                
                const recommendationIcon = invoice.recommendation === 'approved' ? '✓' : 
                                         invoice.recommendation === 'rejected' ? '✗' : '?';
                
                const recommendationClass = invoice.recommendation === 'approved' ? 'approved' : 
                                          invoice.recommendation === 'rejected' ? 'rejected' : 'pending';
                
                row.innerHTML = `
                    <div>
                        <input type="checkbox" class="checkbox" 
                               ${selectedInvoices.has(invoice.id) ? 'checked' : ''}
                               onchange="toggleInvoiceSelection('${invoice.id}')" />
                    </div>
                    <div>${invoice.id}</div>
                    <div>${invoice.vendor}</div>
                    <div>$${invoice.amount.toFixed(2)}</div>
                    <div>${invoice.date}</div>
                    <div>
                        <span class="status-badge status-${statusClass}">${invoice.status}</span>
                    </div>
                    <div>
                        <span class="recommendation ${recommendationClass}">
                            ${recommendationIcon}
                        </span>
                    </div>
                    <div>
                        <span class="po-matches ${invoice.po_matches && invoice.po_matches.length > 0 ? 'has-matches' : 'no-matches'}">
                            ${invoice.po_matches ? invoice.po_matches.length : 0} PO${invoice.po_matches && invoice.po_matches.length !== 1 ? 's' : ''}
                        </span>
                    </div>
                    <div>
                        <button class="btn-small" onclick="viewInvoiceDetails('${invoice.id}')">View</button>
                    </div>
                `;
                
                tableBody.appendChild(row);
            });

            updateReviewButton();
            updateSelectedInvoiceSummary(); // Update summary after table is populated
        }

        function toggleInvoiceSelection(invoiceId) {
            if (selectedInvoices.has(invoiceId)) {
                selectedInvoices.delete(invoiceId);
            } else {
                selectedInvoices.add(invoiceId);
            }
            
            updateInvoiceTable();
            updateReviewButton();
            updateSelectedInvoiceSummary(); // Update summary after selection changes
        }

        function updateReviewButton() {
            const reviewButton = document.getElementById('reviewButton');
            const count = selectedInvoices.size;
            
            reviewButton.textContent = `Review Invoices (${count} selected)`;
            reviewButton.disabled = count === 0;
        }

        // Chat Interface
        function sendMessage() {
            const input = document.getElementById('chatInput');
            console.log('sendMessage called, input element:', input); // Debug
            
            if (!input) {
                console.error('Chat input not found in sendMessage!');
                return;
            }
            
            const message = input.value.trim();
            console.log('Message to send:', message); // Debug
            
            if (!message) return;

            // Add user message
            addChatMessage('user', message);
            input.value = '';

            // Simulate AI response
            setTimeout(() => {
                const response = generateAIResponse(message);
                addChatMessage('assistant', response);
            }, 1000);
        }

        function addChatMessage(sender, text) {
            console.log('Adding chat message:', sender, text); // Debug
            
            const chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) {
                console.error('Chat messages container not found!');
                return;
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            messageDiv.innerHTML = `
                <div class="message-bubble">${text}</div>
                <div class="message-time">${timeString}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Store in history
            chatHistory.push({ sender, text, timestamp: now });
        }

        // Enhanced AI Chat Interface
        function generateAIResponse(message) {
            const lowerMessage = message.toLowerCase();
            const selectedInvoice = getSelectedInvoice();
            
            if (lowerMessage.includes('hello') || lowerMessage.includes('hi')) {
                return 'Hello! I\'m your AI assistant for invoice processing. I can help you understand recommendations, explain matches, and answer questions about your POs and invoices.';
            } else if (lowerMessage.includes('recommendation')) {
                if (selectedInvoice) {
                    return `I can explain the recommendation for invoice ${selectedInvoice.id}. The current recommendation is: ${selectedInvoice.recommendation} with ${(selectedInvoice.confidence * 100).toFixed(1)}% confidence. Would you like me to break down the reasoning?`;
                } else {
                    return 'I can explain any recommendation by analyzing the PO matches, business rules, and confidence scores. Please select an invoice first so I can provide specific details.';
                }
            } else if (lowerMessage.includes('po') || lowerMessage.includes('purchase order')) {
                if (selectedInvoice) {
                    const poCount = selectedInvoice.po_matches ? selectedInvoice.po_matches.length : 0;
                    return `For invoice ${selectedInvoice.id}, I found ${poCount} matching purchase orders. The PO matching algorithm considers vendor names, amounts, dates, and line items. Would you like me to show the detailed matches?`;
                } else {
                    return 'I can help you find matching purchase orders for invoices. Please select an invoice first to see the PO matching details.';
                }
            } else if (lowerMessage.includes('confidence') || lowerMessage.includes('score')) {
                if (selectedInvoice) {
                    return `The confidence score for invoice ${selectedInvoice.id} is ${(selectedInvoice.confidence * 100).toFixed(1)}%. This score is based on:\n\n• PO match quality (40%)\n• Vendor name similarity (30%)\n• Amount validation (20%)\n• Date consistency (10%)\n\n${selectedInvoice.confidence > 0.8 ? 'This is a high-confidence recommendation.' : selectedInvoice.confidence > 0.6 ? 'This is a medium-confidence recommendation that may need review.' : 'This is a low-confidence recommendation that requires manual review.'}`;
                } else {
                    return 'Confidence scores indicate how certain the AI is about its recommendation. They range from 0% (very uncertain) to 100% (very certain). Select an invoice to see its specific confidence breakdown.';
                }
            } else if (lowerMessage.includes('override') || lowerMessage.includes('change')) {
                if (selectedInvoice) {
                    return `I can help you override the recommendation for invoice ${selectedInvoice.id}. Currently it's marked as "${selectedInvoice.recommendation}". What would you like to change it to? You can choose: approved, rejected, or review.`;
                } else {
                    return 'I can help you override recommendations. Please select an invoice first, then tell me what you\'d like to change the recommendation to.';
                }
            } else if (lowerMessage.includes('help') || lowerMessage.includes('what can you do')) {
                return `I'm your AI assistant for invoice processing! Here's what I can help you with:\n\n• **Explain recommendations** - Break down why an invoice was approved/rejected\n• **Show PO matches** - Display matching purchase orders\n• **Calculate confidence** - Explain the AI's confidence score\n• **Override decisions** - Change recommendations when needed\n• **Answer questions** - About your invoices, POs, and business rules\n\nJust select an invoice and ask me anything!`;
            } else {
                return `I understand you're asking about "${message}". Let me help you with that. Could you provide more context about what you need? I can help with invoice processing, PO matching, recommendations, and more.`;
            }
        }

        function getSelectedInvoice() {
            if (selectedInvoices.size === 1) {
                const invoiceId = Array.from(selectedInvoices)[0];
                return currentInvoices.find(inv => inv.id === invoiceId);
            }
            return null;
        }

        // Quick Actions with Real Context
        function explainRecommendation() {
            const selectedInvoice = getSelectedInvoice();
            if (!selectedInvoice) {
                addChatMessage('assistant', 'Please select an invoice first so I can explain the recommendation.');
                return;
            }
            
            const confidence = (selectedInvoice.confidence * 100).toFixed(1);
            const explanation = `**Recommendation Explanation for ${selectedInvoice.id}**\n\n**Current Status:** ${selectedInvoice.recommendation}\n**Confidence:** ${confidence}%\n\n**Reasoning:**\n• Vendor: ${selectedInvoice.vendor}\n• Amount: $${selectedInvoice.amount.toFixed(2)}\n• Date: ${selectedInvoice.date}\n\n**PO Matches:** ${selectedInvoice.po_matches ? selectedInvoice.po_matches.length : 0} found\n\n**Business Rules Applied:**\n• Amount validation against PO limits\n• Vendor name matching\n• Date consistency checks\n• Line item verification`;
            
            addChatMessage('assistant', explanation);
        }

        function showPOMatches() {
            const selectedInvoice = getSelectedInvoice();
            if (!selectedInvoice) {
                addChatMessage('assistant', 'Please select an invoice first to see matching purchase orders.');
                return;
            }
            
            if (selectedInvoice.po_matches && selectedInvoice.po_matches.length > 0) {
                let matchesText = `**PO Matches for ${selectedInvoice.id}**\n\n`;
                selectedInvoice.po_matches.forEach((po, index) => {
                    matchesText += `${index + 1}. **PO ${po.po_number}**\n`;
                    matchesText += `   Vendor: ${po.vendor_name}\n`;
                    matchesText += `   Amount: $${po.total_amount}\n`;
                    matchesText += `   Date: ${po.po_date}\n`;
                    matchesText += `   Match Score: ${(po.match_score * 100).toFixed(1)}%\n\n`;
                });
                addChatMessage('assistant', matchesText);
            } else {
                addChatMessage('assistant', `No matching purchase orders found for invoice ${selectedInvoice.id}. This could mean:\n\n• No POs exist for this vendor\n• Amount exceeds PO limits\n• Date is outside PO validity period\n• Vendor name doesn't match exactly`);
            }
        }

        function showCalculationDetails() {
            const selectedInvoice = getSelectedInvoice();
            if (!selectedInvoice) {
                addChatMessage('assistant', 'Please select an invoice to see detailed calculation information.');
                return;
            }
            
            const confidence = (selectedInvoice.confidence * 100).toFixed(1);
            const calculationDetails = `**Calculation Details for ${selectedInvoice.id}**\n\n**Confidence Score Breakdown:**\n• **PO Match Quality (40%):** ${(selectedInvoice.confidence * 0.4 * 100).toFixed(1)}%\n• **Vendor Name Similarity (30%):** ${(selectedInvoice.confidence * 0.3 * 100).toFixed(1)}%\n• **Amount Validation (20%):** ${(selectedInvoice.confidence * 0.2 * 100).toFixed(1)}%\n• **Date Consistency (10%):** ${(selectedInvoice.confidence * 0.1 * 100).toFixed(1)}%\n\n**Total Confidence:** ${confidence}%\n\n**Recommendation Thresholds:**\n• **Auto-approve:** > 80% confidence\n• **Review required:** 60-80% confidence\n• **Manual review:** < 60% confidence\n\n**Current Decision:** ${selectedInvoice.recommendation}`;
            
            addChatMessage('assistant', calculationDetails);
        }

        function overrideRecommendation() {
            const selectedInvoice = getSelectedInvoice();
            if (!selectedInvoice) {
                addChatMessage('assistant', 'Please select an invoice first if you want to override the recommendation.');
                return;
            }
            
            const newStatus = prompt(`Current recommendation for ${selectedInvoice.id}: ${selectedInvoice.recommendation}\n\nWhat would you like to change it to?\n\nOptions: approved, rejected, review`);
            
            if (newStatus && ['approved', 'rejected', 'review'].includes(newStatus.toLowerCase())) {
                selectedInvoice.recommendation = newStatus.toLowerCase();
                selectedInvoice.status = newStatus.toLowerCase();
                updateInvoiceTable();
                addChatMessage('assistant', `Successfully overridden recommendation for ${selectedInvoice.id} to: ${newStatus}`);
                addChatMessage('user', `Override: ${selectedInvoice.id} → ${newStatus}`);
            } else if (newStatus) {
                addChatMessage('assistant', `Invalid status: "${newStatus}". Please use: approved, rejected, or review.`);
            }
        }

        // Review Panel
        function toggleReviewPanel() {
            const panel = document.getElementById('reviewPanel');
            const toggle = panel.querySelector('.expand-toggle');
            
            if (panel.classList.contains('expanded')) {
                panel.classList.remove('expanded');
                toggle.textContent = '▼';
            } else {
                panel.classList.add('expanded');
                toggle.textContent = '▲';
            }
        }

        // Enhanced Review Panel
        function updateSelectedInvoiceSummary() {
            const summary = document.getElementById('selectedInvoiceSummary');
            
            if (selectedInvoices.size === 0) {
                summary.textContent = 'No invoice selected';
                return;
            }
            
            if (selectedInvoices.size === 1) {
                const invoice = currentInvoices.find(inv => inv.id === Array.from(selectedInvoices)[0]);
                if (invoice) {
                    summary.innerHTML = `
                        <strong>${invoice.id}</strong><br>
                        <span style="color: #64748b;">${invoice.vendor}</span><br>
                        <span style="font-size: 18px; color: #0f172a;">$${invoice.amount.toFixed(2)}</span><br>
                        <span style="color: #64748b;">Date: ${invoice.date}</span><br>
                        <span style="color: #64748b;">Confidence: ${(invoice.confidence * 100).toFixed(1)}%</span>
                    `;
                }
            } else {
                const totalAmount = Array.from(selectedInvoices).reduce((sum, id) => {
                    const invoice = currentInvoices.find(inv => inv.id === id);
                    return sum + (invoice ? invoice.amount : 0);
                }, 0);
                
                summary.innerHTML = `
                    <strong>${selectedInvoices.size} invoices selected</strong><br>
                    <span style="font-size: 18px; color: #0f172a;">Total: $${totalAmount.toFixed(2)}</span><br>
                    <span style="color: #64748b;">Click to review individually</span>
                `;
            }
        }

        // Invoice Actions
        function reviewInvoices() {
            if (selectedInvoices.size === 0) {
                showNotification('Please select invoices to review first.', 'warning');
                return;
            }
            
            const selectedInvoiceIds = Array.from(selectedInvoices);
            showNotification(`Reviewing ${selectedInvoiceIds.length} selected invoices...`, 'info');
            
            // Simulate review process
            setTimeout(() => {
                showNotification(`Review complete for ${selectedInvoiceIds.length} invoices`, 'success');
                selectedInvoices.clear();
                updateInvoiceTable();
                updateReviewButton();
            }, 2000);
        }

        function viewInvoiceDetails(invoiceId) {
            const invoice = currentInvoices.find(inv => inv.id === invoiceId);
            if (!invoice) {
                showNotification('Invoice not found', 'error');
                return;
            }

            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Invoice Details: ${invoice.id}</h3>
                        <button class="modal-close" onclick="closeModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="detail-section">
                            <h4>📋 Basic Information</h4>
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <strong>Invoice ID:</strong> ${invoice.id}
                                </div>
                                <div class="detail-item">
                                    <strong>Vendor:</strong> ${invoice.vendor}
                                </div>
                                <div class="detail-item">
                                    <strong>Amount:</strong> $${invoice.amount.toFixed(2)}
                                </div>
                                <div class="detail-item">
                                    <strong>Date:</strong> ${invoice.date}
                                </div>
                                <div class="detail-item">
                                    <strong>Status:</strong> 
                                    <span class="status-badge status-${invoice.status}">${invoice.status}</span>
                                </div>
                                <div class="detail-item">
                                    <strong>Recommendation:</strong> 
                                    <span class="recommendation ${invoice.recommendation}">${invoice.recommendation === 'approved' ? '✓' : invoice.recommendation === 'rejected' ? '✗' : '?'}</span>
                                </div>
                                <div class="detail-item">
                                    <strong>Confidence:</strong> ${(invoice.confidence * 100).toFixed(1)}%
                                </div>
                            </div>
                        </div>

                        <div class="detail-section">
                            <h4>🔍 PO Matches (${invoice.po_matches ? invoice.po_matches.length : 0})</h4>
                            ${invoice.po_matches && invoice.po_matches.length > 0 ? 
                                invoice.po_matches.map((po, i) => `
                                    <div class="po-match-item">
                                        <div class="po-match-header">
                                            <strong>Match ${i + 1}: PO ${po.po_number}</strong>
                                            <span class="match-score">${(po.match_score * 100).toFixed(1)}%</span>
                                        </div>
                                        <div class="po-match-details">
                                            <div>Vendor: ${po.vendor_name}</div>
                                            <div>Amount: $${po.total_amount.toFixed(2)}</div>
                                            <div>Date: ${po.po_date}</div>
                                            <div>File: ${po.file_path}</div>
                                        </div>
                                        ${po.match_reasons ? `<div class="match-reasons">Match Reasons: ${po.match_reasons.join(', ')}</div>` : ''}
                                    </div>
                                `).join('') : 
                                '<div class="no-matches">No matching purchase orders found</div>'
                            }
                        </div>

                        ${invoice.ai_analysis ? `
                        <div class="detail-section">
                            <h4>🤖 AI Analysis & Recommendation</h4>
                            <div class="ai-analysis">
                                ${invoice.ai_analysis.map(line => `<div class="analysis-line">${line}</div>`).join('')}
                            </div>
                        </div>
                        ` : ''}

                        ${invoice.recommendation_reason ? `
                        <div class="detail-section">
                            <h4>💡 Recommendation Reason</h4>
                            <div class="recommendation-reason">
                                ${invoice.recommendation_reason}
                            </div>
                        </div>
                        ` : ''}

                        ${invoice.fileInfo ? `
                        <div class="detail-section">
                            <h4>📁 File Information</h4>
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <strong>Filename:</strong> ${invoice.fileInfo.name}
                                </div>
                                <div class="detail-item">
                                    <strong>Size:</strong> ${invoice.fileInfo.size} KB
                                </div>
                                <div class="detail-item">
                                    <strong>Type:</strong> ${invoice.fileInfo.type}
                                </div>
                                <div class="detail-item">
                                    <strong>Uploaded:</strong> ${new Date(invoice.fileInfo.uploadedAt).toLocaleString()}
                                </div>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            
            // Auto-close after 15 seconds
            setTimeout(() => {
                if (modal.parentElement) {
                    closeModal();
                }
            }, 15000);
        }

        function closeModal() {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(m => m.remove());
        }

        // Load initial data
        function loadPOFiles() {
            // This would load existing PO files from the database
            currentPOFiles = [];
            updatePOFileList();
            updatePOStats();
        }

        // Missing Functions
        function loadSampleInvoices() {
            // Sample data for demonstration
            currentInvoices = [
                {
                    id: 'INV-001',
                    vendor: 'Acme Construction Supply Co.',
                    amount: 1250.00,
                    date: '2024-01-15',
                    status: 'pending',
                    recommendation: 'pending',
                    po_matches: [],
                    confidence: 0
                },
                {
                    id: 'INV-002',
                    vendor: 'Builders Warehouse & Supply',
                    amount: 875.50,
                    date: '2024-01-16',
                    status: 'pending',
                    recommendation: 'pending',
                    po_matches: [],
                    confidence: 0
                },
                {
                    id: 'INV-003',
                    vendor: 'Construction Materials Plus',
                    amount: 2100.00,
                    date: '2024-01-17',
                    status: 'pending',
                    recommendation: 'pending',
                    po_matches: [],
                    confidence: 0
                }
            ];

            updateInvoiceTable();
        }

        function selectCommonFolder() {
            const commonFolders = [
                { name: '📁 Sample PO - pdf', path: 'sample_data/Sample PO - pdf', description: 'PDF Purchase Orders' },
                { name: '📁 Sample INV - pdf', path: 'sample_data/Sample INV - pdf', description: 'PDF Invoices' },
                { name: '📁 Sample PO - html', path: 'sample_data/Sample PO - html', description: 'HTML Purchase Orders' },
                { name: '📁 Sample INV - html', path: 'sample_data/Sample INV - html', description: 'HTML Invoices' },
                { name: '📁 sample_data (Root)', path: 'sample_data', description: 'All sample data' }
            ];

            let folderList = 'Select a folder to scan:\n\n';
            commonFolders.forEach((folder, index) => {
                folderList += `${index + 1}. ${folder.name}\n   ${folder.description}\n\n`;
            });
            folderList += 'Enter the number or type a custom path:';

            const selection = prompt(folderList);

            if (selection) {
                if (/^\d+$/.test(selection) && parseInt(selection) <= commonFolders.length) {
                    // User selected a number
                    const selectedFolder = commonFolders[parseInt(selection) - 1];
                    document.getElementById('poFolderPath').value = selectedFolder.path;
                    showNotification(`Selected: ${selectedFolder.name}`, 'success');
                    setTimeout(() => scanPOFolder(), 500);
                } else {
                    // User typed a custom path
                    document.getElementById('poFolderPath').value = selection;
                    showNotification(`Custom path set: ${selection}`, 'info');
                    setTimeout(() => scanPOFolder(), 500);
                }
            }
        }

        function selectAllInvoices() {
            currentInvoices.forEach(invoice => {
                if (!selectedInvoices.has(invoice.id)) {
                    selectedInvoices.add(invoice.id);
                }
            });
            updateInvoiceTable();
            updateReviewButton();
            updateSelectedInvoiceSummary();
        }

        function deselectAllInvoices() {
            selectedInvoices.clear();
            updateInvoiceTable();
            updateReviewButton();
            updateSelectedInvoiceSummary();
        }

        // Panel Resizing
        let isResizing = false;
        let currentPanel = null;
        let startX = 0;
        let startWidth = 0;

        function startResize(event, panelId, direction) {
            event.preventDefault();
            isResizing = true;
            currentPanel = document.getElementById(panelId);
            startX = event.clientX;
            startWidth = currentPanel.offsetWidth;
            
            document.addEventListener('mousemove', handleResize);
            document.addEventListener('mouseup', stopResize);
        }

        function handleResize(event) {
            if (!isResizing || !currentPanel) return;
            
            const deltaX = event.clientX - startX;
            let newWidth;
            
            if (currentPanel.id === 'poExplorerPanel') {
                // Left panel - resize from right edge
                newWidth = Math.max(300, Math.min(600, startWidth + deltaX));
                currentPanel.style.width = newWidth + 'px';
            } else if (currentPanel.id === 'invoicePanel') {
                // Center panel - resize from both edges
                newWidth = Math.max(400, Math.min(800, startWidth + deltaX));
                currentPanel.style.width = newWidth + 'px';
            } else if (currentPanel.id === 'chatPanel') {
                // Right panel - resize from left edge
                newWidth = Math.max(300, Math.min(500, startWidth - deltaX));
                currentPanel.style.width = newWidth + 'px';
            }
        }

        function stopResize() {
            isResizing = false;
            currentPanel = null;
            document.removeEventListener('mousemove', handleResize);
            document.removeEventListener('mouseup', stopResize);
        }

        function testChatInput() {
            console.log('=== CHAT INPUT DEBUG ===');
            
            // Check if elements exist
            const chatInput = document.getElementById('chatInput');
            const chatMessages = document.getElementById('chatMessages');
            const chatPanel = document.getElementById('chatPanel');
            
            console.log('Chat input element:', chatInput);
            console.log('Chat messages element:', chatMessages);
            console.log('Chat panel element:', chatPanel);
            
            if (chatInput) {
                console.log('Chat input styles:', window.getComputedStyle(chatInput));
                console.log('Chat input dimensions:', chatInput.offsetWidth, 'x', chatInput.offsetHeight);
                console.log('Chat input visible:', chatInput.offsetParent !== null);
                
                // Try to focus the input
                chatInput.focus();
                console.log('Chat input focused');
                
                // Try to add a test message
                addChatMessage('assistant', 'Test message from debug button');
            } else {
                console.error('Chat input element not found!');
            }
            
            // Check if there are any CSS issues
            const chatInputStyles = window.getComputedStyle(chatInput);
            console.log('Chat input computed styles:', {
                display: chatInputStyles.display,
                visibility: chatInputStyles.visibility,
                opacity: chatInputStyles.opacity,
                zIndex: chatInputStyles.zIndex,
                position: chatInputStyles.position
            });
        }

        function clearPOSelection() {
            currentPOFiles = [];
            document.getElementById('poFolderPath').value = '';
            updatePOFileList();
            updatePOStats();
            showNotification('PO file selection cleared', 'info');
        }

        function refreshInvoices() {
            showNotification('Refreshing invoice list...', 'info');
            // Force reload from API, but preserve existing invoices if API fails
            loadInvoices();
        }



        // Enhanced invoice persistence
        function saveInvoicesToStorage() {
            try {
                const invoiceData = currentInvoices.map(invoice => ({
                    ...invoice,
                    // Convert Date objects to strings for storage
                    timestamp: new Date().toISOString()
                }));
                localStorage.setItem('prat_invoices', JSON.stringify(invoiceData));
                console.log('Invoices saved to local storage:', invoiceData.length);
            } catch (error) {
                console.error('Failed to save invoices to storage:', error);
            }
        }

        function loadInvoicesFromStorage() {
            try {
                const stored = localStorage.getItem('prat_invoices');
                if (stored) {
                    const storedInvoices = JSON.parse(stored);
                    if (storedInvoices && storedInvoices.length > 0) {
                        currentInvoices = storedInvoices;
                        console.log('Loaded invoices from storage:', storedInvoices.length);
                        return true;
                    }
                }
            } catch (error) {
                console.error('Failed to load invoices from storage:', error);
            }
            return false;
        }

        // PO Matching System
        function findMatchingPOs(invoice) {
            if (!currentPOFiles || currentPOFiles.length === 0) {
                return [];
            }

            const matches = [];
            
            // Only consider processed POs
            const processedPOs = currentPOFiles.filter(po => po.status === 'processed' && po.result);
            
            processedPOs.forEach(po => {
                let matchScore = 0;
                let matchReasons = [];
                
                // Strategy 1: Vendor name matching (40% weight)
                const vendorMatch = matchVendorNames(invoice.vendor, po.result.vendor_name);
                if (vendorMatch.score > 0.7) {
                    matchScore += vendorMatch.score * 0.4;
                    matchReasons.push(`Vendor match: ${vendorMatch.score * 100}%`);
                }
                
                // Strategy 2: Amount matching (35% weight)
                const amountMatch = matchAmounts(invoice.amount, po.result.total_amount);
                if (amountMatch.score > 0.6) {
                    matchScore += amountMatch.score * 0.35;
                    matchReasons.push(`Amount match: ${amountMatch.score * 100}%`);
                }
                
                // Strategy 3: Date matching (15% weight)
                const dateMatch = matchDates(invoice.date, po.result.po_date);
                if (dateMatch.score > 0.5) {
                    matchScore += dateMatch.score * 0.15;
                    matchReasons.push(`Date match: ${dateMatch.score * 100}%`);
                }
                
                // Strategy 4: PO number reference (10% weight)
                if (invoice.id && invoice.id.includes(po.result.po_number)) {
                    matchScore += 0.1;
                    matchReasons.push('PO number reference found');
                }
                
                // Only include matches with reasonable scores
                if (matchScore > 0.3) {
                    matches.push({
                        po_number: po.result.po_number,
                        vendor_name: po.result.vendor_name,
                        total_amount: po.result.total_amount,
                        po_date: po.result.po_date,
                        match_score: matchScore,
                        match_reasons: matchReasons,
                        file_path: po.full_path
                    });
                }
            });
            
            // Sort by match score (highest first)
            matches.sort((a, b) => b.match_score - a.match_score);
            
            return matches;
        }

        function matchVendorNames(invoiceVendor, poVendor) {
            if (!invoiceVendor || !poVendor) return { score: 0, reason: 'Missing vendor name' };
            
            const invoiceLower = invoiceVendor.toLowerCase().trim();
            const poLower = poVendor.toLowerCase().trim();
            
            // Exact match
            if (invoiceLower === poLower) {
                return { score: 1.0, reason: 'Exact vendor name match' };
            }
            
            // Contains match
            if (invoiceLower.includes(poLower) || poLower.includes(invoiceLower)) {
                return { score: 0.9, reason: 'Vendor name contains match' };
            }
            
            // Word-by-word matching
            const invoiceWords = invoiceLower.split(/\s+/).filter(word => word.length > 2);
            const poWords = poLower.split(/\s+/).filter(word => word.length > 2);
            
            let commonWords = 0;
            let totalWords = Math.max(invoiceWords.length, poWords.length);
            
            invoiceWords.forEach(word => {
                if (poWords.includes(word)) {
                    commonWords++;
                }
            });
            
            if (totalWords > 0) {
                const wordScore = commonWords / totalWords;
                if (wordScore > 0.5) {
                    return { score: 0.7 + (wordScore * 0.2), reason: `Word match: ${commonWords}/${totalWords}` };
                }
            }
            
            // Fuzzy matching for similar names
            const similarity = calculateStringSimilarity(invoiceLower, poLower);
            if (similarity > 0.8) {
                return { score: 0.6 + (similarity * 0.2), reason: `Fuzzy match: ${similarity * 100}%` };
            }
            
            return { score: 0, reason: 'No vendor name similarity' };
        }

        function matchAmounts(invoiceAmount, poAmount) {
            if (!invoiceAmount || !poAmount) return { score: 0, reason: 'Missing amount' };
            
            const invoice = parseFloat(invoiceAmount);
            const po = parseFloat(poAmount);
            
            if (isNaN(invoice) || isNaN(po)) {
                return { score: 0, reason: 'Invalid amount format' };
            }
            
            // Exact match
            if (invoice === po) {
                return { score: 1.0, reason: 'Exact amount match' };
            }
            
            // Within 5% tolerance
            const tolerance = 0.05;
            const difference = Math.abs(invoice - po);
            const percentageDiff = difference / po;
            
            if (percentageDiff <= tolerance) {
                const score = 1.0 - (percentageDiff / tolerance) * 0.3;
                return { score: score, reason: `Within ${(percentageDiff * 100).toFixed(1)}% tolerance` };
            }
            
            // Within 10% tolerance
            if (percentageDiff <= tolerance * 2) {
                const score = 0.7 - (percentageDiff - tolerance) / tolerance * 0.2;
                return { score: score, reason: `Within ${(percentageDiff * 100).toFixed(1)}% tolerance` };
            }
            
            // Within 20% tolerance
            if (percentageDiff <= tolerance * 4) {
                const score = 0.5 - (percentageDiff - tolerance * 2) / (tolerance * 2) * 0.3;
                return { score: score, reason: `Within ${(percentageDiff * 100).toFixed(1)}% tolerance` };
            }
            
            return { score: 0, reason: `Amount difference: ${(percentageDiff * 100).toFixed(1)}%` };
        }

        function matchDates(invoiceDate, poDate) {
            if (!invoiceDate || !poDate) return { score: 0, reason: 'Missing date' };
            
            try {
                const invoice = new Date(invoiceDate);
                const po = new Date(poDate);
                
                if (isNaN(invoice.getTime()) || isNaN(po.getTime())) {
                    return { score: 0, reason: 'Invalid date format' };
                }
                
                // Exact date match
                if (invoice.toDateString() === po.toDateString()) {
                    return { score: 1.0, reason: 'Exact date match' };
                }
                
                // Within 7 days
                const dayDiff = Math.abs(invoice.getTime() - po.getTime()) / (1000 * 60 * 60 * 24);
                
                if (dayDiff <= 7) {
                    const score = 1.0 - (dayDiff / 7) * 0.3;
                    return { score: score, reason: `Within ${Math.round(dayDiff)} days` };
                }
                
                // Within 30 days
                if (dayDiff <= 30) {
                    const score = 0.7 - (dayDiff - 7) / 23 * 0.2;
                    return { score: score, reason: `Within ${Math.round(dayDiff)} days` };
                }
                
                // Within 90 days
                if (dayDiff <= 90) {
                    const score = 0.5 - (dayDiff - 30) / 60 * 0.3;
                    return { score: score, reason: `Within ${Math.round(dayDiff)} days` };
                }
                
                return { score: 0, reason: `Date difference: ${Math.round(dayDiff)} days` };
                
            } catch (error) {
                return { score: 0, reason: 'Date parsing error' };
            }
        }

        function calculateStringSimilarity(str1, str2) {
            if (str1 === str2) return 1.0;
            if (str1.length === 0) return 0.0;
            if (str2.length === 0) return 0.0;
            
            const longer = str1.length > str2.length ? str1 : str2;
            const shorter = str1.length > str2.length ? str2 : str1;
            
            if (longer.length === 0) return 1.0;
            
            const editDistance = levenshteinDistance(longer, shorter);
            return (longer.length - editDistance) / longer.length;
        }

        function levenshteinDistance(str1, str2) {
            const matrix = [];
            
            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }
            
            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            
            return matrix[str2.length][str1.length];
        }

        // Clear local storage on page load for fresh start
        function clearInvoiceStorage() {
            try {
                localStorage.removeItem('prat_invoices');
                console.log('Invoice storage cleared for fresh start');
            } catch (error) {
                console.error('Failed to clear invoice storage:', error);
            }
        }
    </script>
</body>
</html>